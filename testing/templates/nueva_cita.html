{% extends basehtml %}
{% block head %}
    <title>Agendar Cita</title>
{% endblock %}
{% block body %}
    <h1>Agendar Nueva Cita</h1>
    <h3>Llenar todos los campos solicitados</h3>
    {{ form.as_p }}
    <button class="btn btn-info" element onclick="AddAppointment()">Agendar Cita</button>
{% endblock %}
{% block scripts %}
    <script>
        horaminima = '';
        horamaxima = '';
        $(document).ready(function(){
            $('.datepicker').datepicker({minDate: 0});
            $('#id_Hora').timepicker({
                timeFormat: 'H:mm',
                interval:30,
                minTime:'',
                maxTime:'',
                dropdown: true,
                scrollbar: true,
                dynamic: false
            });
        });
    </script>
    <script>
        $('#id_Fecha').on('change',function() {
            date = $(this).datepicker('getDate');
            dayOfWeek = date.getUTCDay();
            dia = "";
            grupo = "{{ grupo }}";
            if (grupo == "Doctores") {
                doctor = "{{ usuario }}"
            }
            else {
                doctor = $('#id_Doctores').val();
            }
            switch (dayOfWeek) {
                case 1:
                    dia = "Lunes";
                    break;
                case 2:
                    dia = "Martes";
                    break;
                case 3:
                    dia = "Miercoles";
                    break;
                case 4:
                    dia = "Jueves";
                    break;
                case 5:
                    dia = "Viernes";
                    break;
                case 6:
                    dia = "Sabado";
                    break;
                case 0:
                    dia = "Domingo";
                    break;
            }
            $.ajax({  //Call ajax function sending the option loaded
                url: "search_ajax/",  //This is the url of the ajax view where you make the search
                type: 'POST',
                dataType: "json",
                data: {
                    doctor: doctor,
                    dia: dia,
                    tag: "dynamichorarios"
                },
                success: function (response) {
                    horadia = response;
                    horaminima = horadia.substr(0, horadia.indexOf('-'));
                    horamaxima = horadia.substr(horadia.indexOf('-') + 1, horadia.length);
                }
                });
                setTimeout(function() {
                    $('.timepicker').data('TimePicker').options.minTime = horaminima;
                    $('.timepicker').data('TimePicker').options.maxTime = horamaxima;
                    $('.timepicker').data('TimePicker').items = null;
                    $('.timepicker').data('TimePicker').widget.instance = null;
                }, 1500);
            });
    </script>
    <script>
          $('.timepicker').select(function()
            {
                alert('Seleccionado');

            });
    </script>
    <script>
        function AddAppointment(){
            detalle = $('#id_Detalle').val();
            fecha = $('#id_Fecha').val() + " " + $('#id_Hora').val();
            grupo = "{{ grupo }}";
            if(detalle != "" && $('#id_Fecha').val() != "" && $('#id_Hora').val() != "" ) {
                if (grupo == "Doctores") {
                    doctor = "{{ usuario }}";
                    paciente = $('#id_Pacientes').val();
                }
                else if (grupo== "Pacientes")
                {
                    doctor = $('#id_Doctores').val();
                    paciente = "{{ usuario }}"
                }
                else if (grupo== "Administrador")
                {
                    doctor = $('#id_Doctores').val();
                    paciente = $('#id_Pacientes').val();
                }
                    $.ajax({  //Call ajax function sending the option loaded
                        url: "search_ajax/",  //This is the url of the ajax view where you make the search
                        type: 'POST',
                        dataType: "json",
                        data: {
                            doctor: doctor,
                            paciente: paciente,
                            detalle: detalle,
                            fecha: fecha,
                            grupo: grupo,
                            tag: "addcita"
                        },
                        success: function (response) {
                            result = response;
                            if(result==1) {
                                alert('Cita Agendada')
                                window.location.href = '/todas_citas';
                            }
                            else
                            {
                                alert('Fecha y/o hora no disponibles');
                            }
                        }
                    });
            }
            else
            {
                alert('Complete todos los campos')
            }
        }
    </script>
{% endblock %}