{% extends basehtml %}
{% block head %}
    <title>Editar Cita</title>
{% endblock %}
{% block body %}
    <h1>Editar Cita</h1>
    <h3>Llenar todos los campos solicitados</h3>
    {{ form.as_p }}
    <button class="btn btn-info" element onclick="EditAppointment()">Editar Cita</button>
{% endblock %}
{% block scripts %}
    <script>
        var cita =sessionStorage.getItem("sent");
        grupo = "{{ grupo }}";
        $.ajax({  //Call ajax function sending the option loaded
            url: "search_ajax/",  //This is the url of the ajax view where you make the search
            type: 'POST',
            dataType: "json",
            data: {
                cita: cita,
                tag: "populatecita"
            },
            success: function (response) {
                info_cita = response[0];
                doctor = info_cita[0];
                paciente = info_cita[1];
                fecha = info_cita[2];
                detalle = info_cita[3]
                hora = fecha.substring(fecha.indexOf(" ")+1, fecha.length-3);
                fecha = fecha.substring(0,fecha.indexOf(" "));
                partesfecha = fecha.split('-');
                if(grupo == "Pacientes" || grupo=="Administrador"){
                    $('#id_Doctores').val(doctor);
                }
                else if(grupo == "Doctores" || grupo == "Administrador"){
                    $('#id_Pacientes').val(paciente);
                }
                $('#id_Detalle').val(detalle);
                $('#id_Fecha').val(partesfecha[1]+"/"+partesfecha[2]+"/"+partesfecha[0]);
                $('#id_Fecha').trigger('change');
                $('#id_Hora').val(hora);

            }
        });
    </script>
    <script>
        horaminima = '';
        horamaxima = '';
        $(document).ready(function(){
            $('.datepicker').datepicker({minDate: 0});
            $('#id_Hora').timepicker({
                timeFormat: 'H:mm',
                interval:30,
                minTime:'',
                maxTime:'',
                dropdown: true,
                scrollbar: true,
                dynamic: false
            });
        });
    </script>
    <script>
        $('#id_Fecha').on('change',function() {
            date = $(this).datepicker('getDate');
            dayOfWeek = date.getUTCDay();
            dia = "";
            grupo = "{{ grupo }}";
            if (grupo == "Doctores") {
                doctor = "{{ usuario }}"
            }
            else {
                doctor = $('#id_Doctores').val();
            }
            switch (dayOfWeek) {
                case 1:
                    dia = "Lunes";
                    break;
                case 2:
                    dia = "Martes";
                    break;
                case 3:
                    dia = "Miercoles";
                    break;
                case 4:
                    dia = "Jueves";
                    break;
                case 5:
                    dia = "Viernes";
                    break;
                case 6:
                    dia = "Sabado";
                    break;
                case 0:
                    dia = "Domingo";
                    break;
            }
            $.ajax({  //Call ajax function sending the option loaded
                url: "search_ajax/",  //This is the url of the ajax view where you make the search
                type: 'POST',
                dataType: "json",
                data: {
                    doctor: doctor,
                    dia: dia,
                    tag: "dynamichorarios"
                },
                success: function (response) {
                    horadia = response;
                    horaminima = horadia.substr(0, horadia.indexOf('-'));
                    horamaxima = horadia.substr(horadia.indexOf('-') + 1, horadia.length);
                }
                });
                setTimeout(function() {
                    $('.timepicker').data('TimePicker').options.minTime = horaminima;
                    $('.timepicker').data('TimePicker').options.maxTime = horamaxima;
                    $('.timepicker').data('TimePicker').items = null;
                    $('.timepicker').data('TimePicker').widget.instance = null;
                }, 1500);
            });
    </script>
    <script>
          $('.timepicker').select(function()
            {
                alert('Seleccionado');

            });
    </script>
    <script>
        function EditAppointment(){
            detalle = $('#id_Detalle').val();
            fecha = $('#id_Fecha').val() + " " + $('#id_Hora').val();
            grupo = "{{ grupo }}";
            if(detalle != "" && $('#id_Fecha').val() != "" && $('#id_Hora').val() != "" ) {
                if (grupo == "Doctores") {
                    doctor = "{{ usuario }}";
                    paciente = $('#id_Pacientes').val();
                }
                else if (grupo== "Paciente")
                {
                    doctor = $('#id_Doctores').val();
                    paciente = "{{ usuario }}"
                }
                else if (grupo== "Administrador")
                {
                    doctor = $('#id_Doctores').val();
                    paciente = $('#id_Pacientes').val();
                }
                    $.ajax({  //Call ajax function sending the option loaded
                        url: "search_ajax/",  //This is the url of the ajax view where you make the search
                        type: 'POST',
                        dataType: "json",
                        data: {
                            doctor: doctor,
                            paciente: paciente,
                            detalle: detalle,
                            fecha: fecha,
                            grupo: grupo,
                            citanum: cita,
                            tag: "editcita"
                        },
                        success: function (response) {
                            result = response;
                            if(result==1){
                                alert('Modificaci√≥n exitosa');
                                window.close();
                            }
                            else
                            {
                                alert('Fecha y/o hora no disponibles');
                            }

                        }
                    });
            }
            else
            {
                alert('Complete todos los campos')
            }
        }
    </script>
{% endblock %}