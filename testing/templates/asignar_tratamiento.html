{% extends 'base.html' %}
{% block head %}
    <title>Asignar Tratamientos</title>
{% endblock %}
{% block body %}
    {{ form.as_p }}
    <button id="asignar" class="btn btn-info" element onclick="Assign()">Asignar</button>
    <a href="/register/home"  class="btn btn-danger">Cancelar</a>
{% endblock %}
{% block scripts %}
    <script>
        $(document).ready(function(){
            $('.datepicker').datepicker();
            $('.timepicker').timepicker({
                timeFormat: 'H:mm',
                interval:30,
                minTime:'',
                maxTime:'',
                dropdown: true,
                scrollbar: true,
                dynamic: false
            });
        });
    </script>
    <script>
        $('#id_Dia').on('change', function(){
            dia = $('#id_Dia').val();
            doctor = "{{ usuario }}"
            $.ajax({  //Call ajax function sending the option loaded
                url: "search_ajax/",  //This is the url of the ajax view where you make the search
                type: 'POST',
                dataType: "json",
                data: {
                    doctor: doctor,
                    dia: dia,
                    tag: "dynamichorarios"
                },
                success: function (response) {
                    horadia = response;
                    horaminima = horadia.substr(0, horadia.indexOf('-'));
                    horamaxima = horadia.substr(horadia.indexOf('-') + 1, horadia.length);
                }
                });
                setTimeout(function() {
                    $('.timepicker').data('TimePicker').options.minTime = horaminima;
                    $('.timepicker').data('TimePicker').options.maxTime = horamaxima;
                    $('.timepicker').data('TimePicker').items = null;
                    $('.timepicker').data('TimePicker').widget.instance = null;
                }, 1500);
        });
    </script>
    <script>
    function Assign(){
        doctor = "{{ usuario }}";
        paciente = $('#id_Pacientes').val();
        tratamiento = $('#id_Tratamientos').val();
        citas = $('#id_Citas').val();
        dia = $('#id_Dia').val();
        hora = $('#id_Hora_Preferencia').val();
        parseohora = hora.substring(0,hora.indexOf(":"));
        minutos = hora.substring(hora.indexOf(":")+1,hora.length);
        hora = parseInt(parseohora)*2;
        minutos = parseInt(minutos)/30;
        horafinal = hora+minutos;
        alert(horafinal);
        $.ajax({  //Call ajax function sending the option loaded
            url: "search_ajax/",  //This is the url of the ajax view where you make the search
            type: 'POST',
            dataType: "json",
            data: {
                doctor: doctor,
                paciente: paciente,
                tratamiento: tratamiento,
                citas: citas,
                dia: dia,
                hora: horafinal,
                tag:"asignartratamiento"},
                success: function(response) {
                alert('Tratamiento Asignado');
                window.location.href = "/register/home"
                }
            });
    }
    </script>
    <script>
        $('#id_Tratamientos').on('change',function(){
            $.ajax({  //Call ajax function sending the option loaded
            url: "search_ajax/",  //This is the url of the ajax view where you make the search
            type: 'POST',
            dataType: "json",
            data: { tag:"gettreatmentcost"},
                success: function(response) {
                    result=response;
                    costo=0
                    for(i=0; i<result.length; ++i){
                        item = result[i];
                        if(item[0]==$('#id_Tratamientos').val()){
                            $('#id_Costo').val(item[1]);
                            break;
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}